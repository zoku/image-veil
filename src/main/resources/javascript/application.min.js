(function(){var b=5;var j={module:$(".m-settings"),toggle:$(".m-settings--toggle")};var e={module:$(".m-upload"),text:$(".m-upload .m-upload--text"),fileInput:$("#imageFile")};var c={container:$(".m-preview-container"),image:$(".m-preview .m-preview--image"),areas:$(".m-preview .m-preview--areas")};var k={module:$("#uploadform"),options:$("#imageOptions")};var i={module:$("#progress"),bar:$(".m-progress--bar"),label:$(".m-progress--label")};var f=$("#startButton");j.toggle.on("click",function(l){l.preventDefault();if(j.module.hasClass("m-settings_is-visible")){j.module.removeClass("m-settings_is-visible")}else{j.module.addClass("m-settings_is-visible")}});e.fileInput.on("change",function(){var l=this.files[0];j.module.hide();f.hide();e.text.removeClass("m-upload--text_small");c.areas.empty();if(l.size>b*1024*1024){e.text.text(e.module.data("i18n--file-size-hint").replace("[size1]",(l.size/1024/1024).toFixed(2)).replace("[size2]",b));c.container.hide();return}if(l.type!=="image/jpeg"){e.text.text(e.module.data("i18n--file-type-hint").replace("[type]",l.type));c.container.hide();return}e.text.addClass("m-upload--text_small").html(l.name+"<br>"+e.module.data("i18n--new-file-hint"));d(this);j.module.show();f.show()});f.on("click",function(n){n.preventDefault();f.hide();j.module.removeClass("m-settings_is-visible");i.bar.css({width:0});i.module.show();var m={};var l=[];c.areas.find(".m-preview--areas--area").each(function(o,p){l.push({x:$(p).position().left.toFixed(0),y:$(p).position().top.toFixed(0),width:$(p).width().toFixed(0),height:$(p).height().toFixed(0)})});m.areas=l;m.data={width:c.image.width(),height:c.image.height()};m.mode=$("#mode :selected").val();m.addNoise=$("#addNoise").is(":checked");m.resize=$("#resize").is(":checked");k.options.val(JSON.stringify(m));$.ajax({url:"/imagereceiver",type:"POST",data:new FormData(k.module[0]),cache:false,contentType:false,processData:false,xhr:function(){var o=$.ajaxSettings.xhr();if(o.upload){o.upload.addEventListener("progress",function(p){if(p.lengthComputable){i.bar.css({width:(p.loaded/p.total*100)+"%"});i.label.text(i.label.data("i18n--upload").replace("[state]",(p.loaded/p.total*100).toFixed(0)));if(p.loaded===p.total){i.bar.css({width:0}).addClass("m-progress--bar_indeterminate");i.label.text(i.label.data("i18n--work"))}}},false)}o.addEventListener("progress",function(p){if(p.lengthComputable){i.bar.removeClass("m-progress--bar_indeterminate");i.bar.css({width:(p.loaded/p.total*100)+"%"});i.label.text(i.label.data("i18n--download").replace("[state]",(p.loaded/p.total*100).toFixed(0)))}});return o}}).done(function(o){var p=JSON.parse(o);if(p.success){var q=$(".m-download");q.find("img").attr("src",p.image);q.fadeIn()}else{e.text.text(p.error).removeClass("m-upload--text_small");c.container.hide()}}).always(function(){i.bar.removeClass("m-progress--bar_indeterminate");i.module.hide();f.show()})});c.areas.on("click",function(l){g(l.offsetX,l.offsetY,100,100)});$(window,document).on("resize",function(){$(".m-preview--areas--area--image").each(function(){a(this)})});$(".m-download--close").on("click",function(l){l.preventDefault();$(".m-download").fadeOut()});function a(r,l){var n=$(r);var q=n.find(".m-preview--areas--area--image-container--image");q.css({"background-size":c.image.width()+"px "+c.image.height()+"px",backgroundPositionX:0-n.position().left+15,backgroundPositionY:0-n.position().top+15});if(l){var o=n.position().left/c.image.width()*100;var m=n.position().top/c.image.height()*100;var p=n.outerWidth()/c.image.width()*100;var s=n.outerHeight()/c.image.height()*100;n.css({left:o+"%",top:m+"%",width:p+"%",height:s+"%"})}}var h=800;c.image.on("load",function(){c.container.show();if(c.container.width()<c.image.width()){c.container.scrollLeft((c.image.width()-c.container.width())/2).find(".m-preview-container--touch-help").fadeIn(h,function(){c.container.animate({scrollLeft:c.image.width()-c.container.width()},h,function(){c.container.animate({scrollLeft:0},h,function(){c.container.animate({scrollLeft:(c.image.width()-c.container.width())/2},h,function(){c.container.find(".m-preview-container--touch-help").fadeOut(h)})})})})}});function d(m){if(m.files&&m.files[0]){var l=new FileReader();l.onload=function(n){c.image.attr("src",n.target.result)};l.readAsDataURL(m.files[0])}}function g(l,o,m,n){l=l-m/2;o=o-n/2;if(l<0){l=0}if(o<0){o=0}if(l>c.areas.width()-m){l=c.areas.width()-m}if(o>c.areas.height()-n){o=c.areas.height()-n}c.areas.append($("<div/>").addClass("m-preview--areas--area").css({width:m/c.image.width()*100+"%",height:n/c.image.height()*100+"%",top:o/c.image.height()*100+"%",left:l/c.image.width()*100+"%"}).append($("<div/>").addClass("m-preview--areas--area--image-container").append($("<div/>").addClass("m-preview--areas--area--image-container--image").css({backgroundImage:"url("+c.image.attr("src")+")",backgroundPositionX:0-l+15,backgroundPositionY:0-o+15,"background-size":c.image.width()+"px "+c.image.height()+"px"}))).append($("<button/>").html('<i class="fas fa-times"></i>').addClass("m-preview--areas--area--remove").on("click",function(p){p.stopPropagation();$(this).parent().remove()})).on("click",function(p){p.stopPropagation()}).draggable({containment:"parent",drag:function(){a(this)},stop:function(){a(this,true)}}).resizable({containment:"parent",handles:"n,e,s,w,nw,se,sw",minWidth:60,minHeight:60,resize:function(){a(this)},stop:function(){a(this,true)}}))}})();