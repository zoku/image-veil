(function(){var c=5;var k={module:$(".m-settings"),toggle:$(".m-settings--toggle")};var f={module:$(".m-upload"),text:$(".m-upload .m-upload--text"),fileInput:$("#imageFile")};var d={container:$(".m-preview-container"),image:$(".m-preview .m-preview--image"),areas:$(".m-preview .m-preview--areas")};var l={module:$("#uploadform"),options:$("#imageOptions")};var j={module:$("#progress"),bar:$(".m-progress--bar"),label:$(".m-progress--label")};var g=$("#startButton");k.toggle.on("click",function(m){m.preventDefault();if(k.module.hasClass("m-settings_is-visible")){k.module.removeClass("m-settings_is-visible")}else{k.module.addClass("m-settings_is-visible")}});f.fileInput.on("change",function(){var m=this.files[0];k.module.hide();g.hide();f.text.removeClass("m-upload--text_small");d.areas.empty();if(m.size>c*1024*1024){f.text.text(f.module.data("i18n--file-size-hint").replace("[size1]",(m.size/1024/1024).toFixed(2)).replace("[size2]",c));d.container.hide();return}if(m.type!=="image/jpeg"){f.text.text(f.module.data("i18n--file-type-hint").replace("[type]",m.type));d.container.hide();return}f.text.addClass("m-upload--text_small").html(m.name+"<br>"+f.module.data("i18n--new-file-hint"));e(this);k.module.show();g.show()});g.on("click",function(o){o.preventDefault();g.hide();k.module.removeClass("m-settings_is-visible");j.bar.css({width:0});j.module.show();var n={};var m=[];d.areas.find(".m-preview--areas--area").each(function(p,q){m.push({x:$(q).position().left.toFixed(0),y:$(q).position().top.toFixed(0),width:$(q).width().toFixed(0),height:$(q).height().toFixed(0)})});n.areas=m;n.data={width:d.image.width(),height:d.image.height()};n.mode=$("#mode :selected").val();n.addNoise=$("#addNoise").is(":checked");n.resize=$("#resize").is(":checked");l.options.val(JSON.stringify(n));$.ajax({url:"./imagereceiver",type:"POST",data:new FormData(l.module[0]),cache:false,contentType:false,processData:false,xhr:function(){var p=$.ajaxSettings.xhr();if(p.upload){p.upload.addEventListener("progress",function(q){if(q.lengthComputable){j.bar.css({width:(q.loaded/q.total*100)+"%"});j.label.text(j.label.data("i18n--upload").replace("[state]",(q.loaded/q.total*100).toFixed(0)));if(q.loaded===q.total){j.bar.css({width:0}).addClass("m-progress--bar_indeterminate");j.label.text(j.label.data("i18n--work"))}}},false)}p.addEventListener("progress",function(q){if(q.lengthComputable){j.bar.removeClass("m-progress--bar_indeterminate");j.bar.css({width:(q.loaded/q.total*100)+"%"});j.label.text(j.label.data("i18n--download").replace("[state]",(q.loaded/q.total*100).toFixed(0)))}});return p}}).done(function(p){var q=JSON.parse(p);if(q.success){var r=$(".m-download");r.find("img").attr("src","data:image/jpeg;base64,"+q.image);r.find(".m-download--content--cta").on("click",function(s){s.preventDefault();$("a").attr("href",window.URL.createObjectURL(b(q.image))).attr("download","anonymous-image.jpg").click()});r.fadeIn()}else{f.text.text(q.error).removeClass("m-upload--text_small");d.container.hide()}}).always(function(){j.bar.removeClass("m-progress--bar_indeterminate");j.module.hide();g.show()})});d.areas.on("click",function(m){h(m.offsetX,m.offsetY,100,100)});$(window,document).on("resize",function(){$(".m-preview--areas--area--image").each(function(){a(this)})});$(".m-download--close").on("click",function(m){m.preventDefault();$(".m-download").fadeOut()});function b(p){var r=atob(p);var m=r.length;var o=new ArrayBuffer(m);var n=new Uint8Array(o);for(var q=0;q<m;q++){n[q]=r.charCodeAt(q)}return new Blob([n])}function a(s,m){var o=$(s);var r=o.find(".m-preview--areas--area--image-container--image");r.css({"background-size":d.image.width()+"px "+d.image.height()+"px",backgroundPositionX:0-o.position().left+15,backgroundPositionY:0-o.position().top+15});if(m){var p=o.position().left/d.image.width()*100;var n=o.position().top/d.image.height()*100;var q=o.outerWidth()/d.image.width()*100;var t=o.outerHeight()/d.image.height()*100;o.css({left:p+"%",top:n+"%",width:q+"%",height:t+"%"})}}var i=800;d.image.on("load",function(){d.container.show();if(d.container.width()<d.image.width()){d.container.scrollLeft((d.image.width()-d.container.width())/2).find(".m-preview-container--touch-help").fadeIn(i,function(){d.container.animate({scrollLeft:d.image.width()-d.container.width()},i,function(){d.container.animate({scrollLeft:0},i,function(){d.container.animate({scrollLeft:(d.image.width()-d.container.width())/2},i,function(){d.container.find(".m-preview-container--touch-help").fadeOut(i)})})})})}});function e(n){if(n.files&&n.files[0]){var m=new FileReader();m.onload=function(o){d.image.attr("src",o.target.result)};m.readAsDataURL(n.files[0])}}function h(m,p,n,o){m=m-n/2;p=p-o/2;if(m<0){m=0}if(p<0){p=0}if(m>d.areas.width()-n){m=d.areas.width()-n}if(p>d.areas.height()-o){p=d.areas.height()-o}d.areas.append($("<div/>").addClass("m-preview--areas--area").css({width:n/d.image.width()*100+"%",height:o/d.image.height()*100+"%",top:p/d.image.height()*100+"%",left:m/d.image.width()*100+"%"}).append($("<div/>").addClass("m-preview--areas--area--image-container").append($("<div/>").addClass("m-preview--areas--area--image-container--image").css({backgroundImage:"url("+d.image.attr("src")+")",backgroundPositionX:0-m+15,backgroundPositionY:0-p+15,"background-size":d.image.width()+"px "+d.image.height()+"px"}))).append($("<button/>").html('<i class="fas fa-times"></i>').addClass("m-preview--areas--area--remove").on("click",function(q){q.stopPropagation();$(this).parent().remove()})).on("click",function(q){q.stopPropagation()}).draggable({containment:"parent",drag:function(){a(this)},stop:function(){a(this,true)}}).resizable({containment:"parent",handles:"n,e,s,w,nw,se,sw",minWidth:60,minHeight:60,resize:function(){a(this)},stop:function(){a(this,true)}}))}})();