(function(){var b=5;var i={module:$(".m-settings"),toggle:$(".m-settings--toggle")};var e={module:$(".m-upload"),text:$(".m-upload .m-upload--text"),fileInput:$("#imageFile")};var c={module:$(".m-preview"),image:$(".m-preview .m-preview--image"),shadow:$(".m-preview .m-preview--shadow"),areas:$(".m-preview .m-preview--areas")};var j={module:$("#uploadform"),options:$("#imageOptions")};var h={module:$("#progress"),bar:$(".m-progress--bar"),label:$(".m-progress--label")};var f=$("#startButton");i.toggle.on("click",function(k){k.preventDefault();if(i.module.hasClass("m-settings_is-visible")){i.module.removeClass("m-settings_is-visible")}else{i.module.addClass("m-settings_is-visible")}});e.fileInput.on("change",function(){var k=this.files[0];i.module.hide();f.hide();e.text.removeClass("m-upload--text_small");c.areas.empty();if(k.size>b*1024*1024){e.text.text(e.module.data("i18n--file-size-hint").replace("[size1]",(k.size/1024/1024).toFixed(2)).replace("[size2]",b));c.module.hide();return}if(k.type!=="image/jpeg"){e.text.text(e.module.data("i18n--file-type-hint").replace("[type]",k.type));c.module.hide();return}e.text.addClass("m-upload--text_small").html(k.name+"<br>"+e.module.data("i18n--new-file-hint"));d(this);i.module.show();f.show()});f.on("click",function(m){m.preventDefault();f.hide();i.module.removeClass("m-settings_is-visible");h.bar.css({width:0});h.module.show();var l={};var k=[];c.areas.find(".m-preview--areas--area").each(function(n,o){k.push({x:$(o).position().left.toFixed(0),y:$(o).position().top.toFixed(0),width:$(o).width().toFixed(0),height:$(o).height().toFixed(0)})});l.areas=k;l.data={width:c.image.width(),height:c.image.height()};l.mode=$("#mode :selected").val();l.addNoise=$("#addNoise").is(":checked");l.resize=$("#resize").is(":checked");j.options.val(JSON.stringify(l));$.ajax({url:"/imagereceiver",type:"POST",data:new FormData(j.module[0]),cache:false,contentType:false,processData:false,xhr:function(){var n=$.ajaxSettings.xhr();if(n.upload){n.upload.addEventListener("progress",function(o){if(o.lengthComputable){h.bar.css({width:(o.loaded/o.total*100)+"%"});h.label.text(h.label.data("i18n--upload").replace("[state]",(o.loaded/o.total*100).toFixed(0)));if(o.loaded===o.total){h.bar.css({width:0}).addClass("m-progress--bar_indeterminate");h.label.text(h.label.data("i18n--work"))}}},false)}n.addEventListener("progress",function(o){if(o.lengthComputable){h.bar.removeClass("m-progress--bar_indeterminate");h.bar.css({width:(o.loaded/o.total*100)+"%"});h.label.text(h.label.data("i18n--download").replace("[state]",(o.loaded/o.total*100).toFixed(0)))}});return n}}).done(function(n){var o=JSON.parse(n);if(o.success){var p=$(".m-download");p.find("img").attr("src",o.image);p.fadeIn()}else{e.text.text(o.error).removeClass("m-upload--text_small");c.module.hide()}}).always(function(){h.bar.removeClass("m-progress--bar_indeterminate");h.module.hide();f.show()})});c.areas.on("click",function(k){g(k.offsetX,k.offsetY,100,100)});$(window,document).on("resize",function(){$(".m-preview--areas--area--image").each(function(){a(this)})});$(".m-download--close").on("click",function(k){k.preventDefault();$(".m-download").fadeOut()});function a(q,k){var m=$(q);var p=m.find(".m-preview--areas--area--image-container--image");p.css({"background-size":c.image.width()+"px "+c.image.height()+"px",backgroundPositionX:0-m.position().left+15,backgroundPositionY:0-m.position().top+15});if(k){var n=m.position().left/c.image.width()*100;var l=m.position().top/c.image.height()*100;var o=m.outerWidth()/c.image.width()*100;var r=m.outerHeight()/c.image.height()*100;m.css({left:n+"%",top:l+"%",width:o+"%",height:r+"%"})}}function d(l){if(l.files&&l.files[0]){var k=new FileReader();k.onload=function(m){c.image.attr("src",m.target.result)};k.readAsDataURL(l.files[0]);c.module.show()}}function g(k,n,l,m){k=k-l/2;n=n-m/2;if(k<0){k=0}if(n<0){n=0}if(k>c.areas.width()-l){k=c.areas.width()-l}if(n>c.areas.height()-m){n=c.areas.height()-m}c.areas.append($("<div/>").addClass("m-preview--areas--area").css({width:l/c.image.width()*100+"%",height:m/c.image.height()*100+"%",top:n/c.image.height()*100+"%",left:k/c.image.width()*100+"%"}).append($("<div/>").addClass("m-preview--areas--area--image-container").append($("<div/>").addClass("m-preview--areas--area--image-container--image").css({backgroundImage:"url("+c.image.attr("src")+")",backgroundPositionX:0-k+15,backgroundPositionY:0-n+15,"background-size":c.image.width()+"px "+c.image.height()+"px"}))).append($("<button/>").html('<i class="fas fa-times"></i>').addClass("m-preview--areas--area--remove").on("click",function(o){o.stopPropagation();$(this).parent().remove()})).on("click",function(o){o.stopPropagation()}).draggable({containment:"parent",drag:function(){a(this)},stop:function(){a(this,true)}}).resizable({containment:"parent",handles:"n,e,s,w,nw,se,sw",minWidth:60,minHeight:60,resize:function(){a(this)},stop:function(){a(this,true)}}))}})();