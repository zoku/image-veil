var canvasContainer=document.getElementById("canvasContainer");var canvas=document.getElementById("imageCanvas");var ctx=canvas.getContext("2d");var originalImg=new Image();var crystallizedImg=new Image();var originalImageDimensions={width:0,height:0};var tools=document.getElementById("tools");var brushOutline_canvas=document.getElementById("brushOutline");var brushOutline_ctx=brushOutline_canvas.getContext("2d");var brushOutline_setSize=function(b){var a=b*zoomFactor;brushOutline_canvas.width=a;brushOutline_canvas.height=a;brushOutline_ctx.strokeStyle="rgb(0,0,0)";brushOutline_ctx.beginPath();brushOutline_ctx.arc(a/2,a/2,a/2,0,Math.PI*2,true);brushOutline_ctx.stroke()};var zoomFactor=1;var mouseZoom=false;var wheelZoomDone=false;var isBrushing=false;var wasBrushing=false;var isErasing=false;var brushSize=100;brushOutline_setSize(brushSize);var toolSettings=document.getElementById("tool-settings");var toolSettingsRail=document.getElementById("tool-settings-rail");var toolSettingsKnob=document.getElementById("tool-settings-knob");var toolSettingsLabel=document.getElementById("tool-settings-label");var toolSettingsCallback=function(a){};var menuIsOpen=false;function openFile(c){var b=c.target;var a=new FileReader();a.onload=function(){originalImg.src=a.result};a.readAsDataURL(b.files[0])}document.getElementById("canvas-file-input").addEventListener("change",openFile);originalImg.onload=function(){loadImage(this)};function loadImage(h){canvasContainer.style.display="none";zoomFactor=1;document.getElementById("status--zoom").innerHTML="100%";document.getElementById("status--size").innerHTML=h.width+"&times;"+h.height;originalImageDimensions.width=h.width;originalImageDimensions.height=h.height;canvasContainer.width=h.width;canvasContainer.height=h.height;canvasContainer.style.left=document.body.clientWidth/2-h.width/2;canvasContainer.style.top=document.body.clientHeight/2-h.height/2;canvas.width=h.width;canvas.height=h.height;canvasContainer.style.width=h.width;canvasContainer.style.height=h.height;ctx.drawImage(h,0,0,h.width,h.height);imageData=ctx.getImageData(0,0,h.width,h.height);var f=new ArrayBuffer(imageData.data.length);var b=new Uint8ClampedArray(f);for(var e=0;e<imageData.data.length;e++){b[e]=imageData.data[e]}var g=new ArrayBuffer(imageData.data.length);var a=new Uint8ClampedArray(g);var d=new Uint32Array(g);for(var c=0;c<imageData.data.length;c++){a[c]=imageData.data[c]}crystallize(d,h.width,h.height);drawBuffer(a);crystallizedImg.src=canvas.toDataURL();drawBuffer(b);setBrushable(canvasContainer);document.getElementById("tools--tool--brush").classList.add("is-active");canvasContainer.style.display="block";tools.style.display="block";document.getElementById("menu--file--save").classList.remove("menus--items--item--submenu--item_disabled");closeAllMenus()}var menuItems=document.getElementsByClassName("menus--items--item");var submenus=document.getElementsByClassName("menus--items--item--submenu");function closeAllMenus(){for(var a=0;a<submenus.length;a++){submenus[a].style.display="none"}}for(var i=0;i<menuItems.length;i++){var menuItem=menuItems[i];menuItem.addEventListener("click",function(a){a.stopPropagation();if(this.getElementsByClassName("menus--items--item--submenu")[0].style.display==="block"){this.getElementsByClassName("menus--items--item--submenu")[0].style.display="none";menuIsOpen=false}else{closeAllMenus();this.getElementsByClassName("menus--items--item--submenu")[0].style.display="block";menuIsOpen=true}});menuItem.addEventListener("mouseenter",function(){if(!menuIsOpen){return}if(this.getElementsByClassName("menus--items--item--submenu")[0].style.display!=="block"){closeAllMenus();this.getElementsByClassName("menus--items--item--submenu")[0].style.display="block"}})}document.getElementsByTagName("body")[0].addEventListener("click",function(){closeAllMenus();menuIsOpen=false});document.getElementById("menu--file--open").addEventListener("click",function(){closeAllMenus();document.getElementById("canvas-file-input").click()});document.getElementById("menu--file--save").addEventListener("click",function(){if(this.classList.contains("menus--items--item--submenu--item_disabled")){return}closeAllMenus();var a=document.createElement("a");a.setAttribute("href",canvas.toDataURL("image/jpeg",0.8));a.setAttribute("target","_blank");a.setAttribute("download","anonymous-image.jpg");a.click()});document.getElementById("tools--tool--move").addEventListener("click",function(a){a.preventDefault();setZoomable(canvasContainer,false);document.getElementById("tools--tool--zoom").classList.remove("is-active");setBrushable(canvasContainer,false);document.getElementById("tools--tool--brush").classList.remove("is-active");isErasing=false;document.getElementById("tools--tool--eraser").classList.remove("is-active");setDraggable(canvasContainer);document.getElementById("tools--tool--move").classList.add("is-active")});document.getElementById("tools--tool--zoom").addEventListener("click",function(a){a.preventDefault();setDraggable(canvasContainer,false);document.getElementById("tools--tool--move").classList.remove("is-active");setBrushable(canvasContainer,false);document.getElementById("tools--tool--brush").classList.remove("is-active");isErasing=false;document.getElementById("tools--tool--eraser").classList.remove("is-active");setZoomable(canvasContainer);document.getElementById("tools--tool--zoom").classList.add("is-active")});document.getElementById("tools--tool--brush").addEventListener("click",function(a){a.preventDefault();setDraggable(canvasContainer,false);document.getElementById("tools--tool--move").classList.remove("is-active");setZoomable(canvasContainer,false);document.getElementById("tools--tool--zoom").classList.remove("is-active");isErasing=false;document.getElementById("tools--tool--eraser").classList.remove("is-active");setBrushable(canvasContainer);document.getElementById("tools--tool--brush").classList.add("is-active")});document.getElementById("tools--tool--eraser").addEventListener("click",function(a){a.preventDefault();setDraggable(canvasContainer,false);document.getElementById("tools--tool--move").classList.remove("is-active");setZoomable(canvasContainer,false);document.getElementById("tools--tool--zoom").classList.remove("is-active");document.getElementById("tools--tool--brush").classList.remove("is-active");setBrushable(canvasContainer,true);isErasing=true;document.getElementById("tools--tool--eraser").classList.add("is-active")});document.addEventListener("keydown",function(a){a.stopPropagation();if(a.code==="Space"){if(canvasContainer.getAttribute("data-is-brushable")==="true"){setBrushable(canvasContainer,false);wasBrushing=true}setDraggable(canvasContainer);canvasContainer.classList.remove("zoom")}if(a.code==="KeyY"){mouseZoom=true;canvasContainer.classList.add("zoom")}});document.addEventListener("keyup",function(a){if(a.code==="Space"){setDraggable(canvasContainer,false);if(wasBrushing){wasBrushing=false;setBrushable(canvasContainer)}}if(a.code==="KeyY"){if(!wheelZoomDone){document.getElementById("tools--tool--zoom").click()}wheelZoomDone=false;mouseZoom=false}if(a.code==="KeyM"){document.getElementById("tools--tool--move").click()}if(a.code==="KeyB"){document.getElementById("tools--tool--brush").click()}if(a.code==="KeyE"){document.getElementById("tools--tool--eraser").click()}});canvasContainer.addEventListener("mousewheel",function(a){if(mouseZoom){wheelZoomDone=true;changeZoom(canvasContainer,a.deltaY>0?"-":"+",a)}});canvasContainer.addEventListener("mousemove",function(a){if(a.shiftKey&&this.getAttribute("data-is-zoomable")==="true"){this.classList.add("is-zoomable_out")}else{this.classList.remove("is-zoomable_out")}});document.addEventListener("contextmenu",function(a){a.preventDefault();if(toolSettings.getAttribute("data-tool")==="none"){return}if(toolSettings.getAttribute("data-tool")==="brush"){toolSettingsCallback=function(){setBrushSize(toolSettings.getAttribute("data-value-log"));brushOutline_canvas.style.left=a.offsetX-brushSize*zoomFactor/2;brushOutline_canvas.style.top=a.offsetY-brushSize*zoomFactor/2}}if(toolSettings.getAttribute("data-tool")==="zoom"){}toolSettings.style.left=a.clientX+"px";toolSettings.style.top=a.clientY+"px";toolSettings.style.display="block"});document.addEventListener("click",function(){toolSettings.style.display="none"});toolSettingsKnob.addEventListener("mousedown",function(){document.addEventListener("mousemove",moveToolSettingsKnob);document.addEventListener("mouseup",unmoveToolSettingsKnob);toolSettingsLabel.style.display="block"});function unmoveToolSettingsKnob(){document.removeEventListener("mousemove",moveToolSettingsKnob);document.removeEventListener("mouseup",unmoveToolSettingsKnob);toolSettingsLabel.style.display="none";toolSettings.style.display="none";toolSettingsCallback()}function moveToolSettingsKnob(h){var c=offset(toolSettingsRail).left;var g=0-(toolSettingsKnob.clientWidth/2);var d=toolSettingsRail.clientWidth-(toolSettingsKnob.clientWidth/2);var b=h.clientX-c-(toolSettingsKnob.clientWidth/2);if(b<g){b=g}if(b>d){b=d}var f=(b+(toolSettingsKnob.clientWidth/2))/(d+(toolSettingsKnob.clientWidth/2));var a=getLogValues(f,1,3000);toolSettingsKnob.style.left=b;if(toolSettings.getAttribute("data-label-mode")==="%"){toolSettingsLabel.innerHTML=(f*100).toFixed(0)+" %"}else{if(toolSettings.getAttribute("data-label-mode")==="log"){toolSettingsLabel.innerHTML=a.toFixed(0)+" px"}else{toolSettingsLabel.innerHTML=f.toFixed(2)}}toolSettings.setAttribute("data-value-percent",(f*100).toFixed(2));toolSettings.setAttribute("data-value-log",a.toFixed(2))}function getLogValues(b,d,a){var f=0;var e=100;var c=Math.log(d);var h=Math.log(a);var g=(h-c)/(e-f);return Math.exp(c+g*(b*100-f))}var zoomClickHelper=function(a){if(this.getAttribute("data-is-draggable")==="true"){return}changeZoom(this,a.shiftKey?"-":"+",a)};function setZoomable(a,b){var c=b!==false;if(a.getAttribute("data-is-zoomable")==="true"&&c){return a}if(c){a.addEventListener("click",zoomClickHelper);a.setAttribute("data-is-zoomable",true);a.classList.add("is-zoomable");toolSettings.setAttribute("data-tool","zoom")}else{a.removeEventListener("click",zoomClickHelper);a.setAttribute("data-is-zoomable",false);a.classList.remove("is-zoomable")}return a}function changeZoom(d,g,a,f){var e=0.1;if(f===true){zoomFactor=1}else{if(g==="-"){zoomFactor-=e}else{zoomFactor+=e}if(zoomFactor<e){zoomFactor=e}if(zoomFactor>40){zoomFactor=40}}var j=d.offsetWidth-originalImageDimensions.width*zoomFactor;var h=d.offsetHeight-originalImageDimensions.height*zoomFactor;var c=a.offsetX-a.offsetX*e;var b=a.offsetY-a.offsetY*e;d.style.width=originalImageDimensions.width*zoomFactor;d.style.height=originalImageDimensions.height*zoomFactor;d.style.left=offset(d).left+j*(c/(originalImageDimensions.width*zoomFactor));d.style.top=offset(d).top+h*(b/(originalImageDimensions.height*zoomFactor));brushOutline_setSize(brushSize);brushOutline_canvas.style.left=a.offsetX-brushSize*zoomFactor/2;brushOutline_canvas.style.top=a.offsetY-brushSize*zoomFactor/2;document.getElementById("status--zoom").innerHTML=(zoomFactor*100).toFixed(0)+"%"}var activateDrag=function(a){this.setAttribute("data-is-dragged",true);this.setAttribute("data-drag-offset-x",a.offsetX);this.setAttribute("data-drag-offset-y",a.offsetY)};var deactivateDrag=function(){this.setAttribute("data-is-dragged",false)};var doDrag=function(a){if(this.getAttribute("data-is-dragged")==="true"){this.style.left=(a.clientX-this.getAttribute("data-drag-offset-x"))+"px";this.style.top=(a.clientY-this.getAttribute("data-drag-offset-y"))+"px"}};function setDraggable(a,b){var c=b!==false;if(a.getAttribute("data-is-draggable")==="true"&&c){return a}if(!c){a.setAttribute("data-is-draggable",false);a.setAttribute("data-is-dragged",false);a.classList.remove("is-draggable");a.removeEventListener("mousedown",activateDrag);a.removeEventListener("mouseup",deactivateDrag);a.removeEventListener("mouseout",deactivateDrag);a.removeEventListener("mousemove",doDrag);return a}a.setAttribute("data-is-draggable",true);a.setAttribute("data-is-dragged",false);a.classList.add("is-draggable");a.addEventListener("mousedown",activateDrag);a.addEventListener("mouseup",deactivateDrag);a.addEventListener("mouseout",deactivateDrag);a.addEventListener("mousemove",doDrag);toolSettings.setAttribute("data-tool","none");return a}var startBrush=function(){isBrushing=true};var stopBrush=function(){isBrushing=false};var doBrush=function(b){var a=b.offsetX;var c=b.offsetY;brushOutline_canvas.style.display="block";brushOutline_canvas.style.left=a-brushSize*zoomFactor/2;brushOutline_canvas.style.top=c-brushSize*zoomFactor/2;if(!isBrushing&&b.type!=="click"){return}ctx.save();ctx.beginPath();ctx.arc(a/zoomFactor,c/zoomFactor,brushSize/2,0,Math.PI*2);ctx.closePath();ctx.clip();ctx.drawImage(b.shiftKey||isErasing?originalImg:crystallizedImg,a/zoomFactor-brushSize/2,c/zoomFactor-brushSize/2,brushSize,brushSize,a/zoomFactor-brushSize/2,c/zoomFactor-brushSize/2,brushSize,brushSize);ctx.restore()};var brushLeaves=function(a){brushOutline_canvas.style.display="none"};function setBrushable(a,b){var c=b!==false;if(a.getAttribute("data-is-brushable")==="true"&&c){return a}if(!c){a.setAttribute("data-is-brushable",false);a.classList.remove("is-brushable");canvas.removeEventListener("mousedown",startBrush);canvas.removeEventListener("mouseup",stopBrush);canvas.removeEventListener("mousemove",doBrush);canvas.removeEventListener("click",doBrush);canvas.removeEventListener("mouseleave",brushLeaves);brushOutline_canvas.style.display="none";return a}a.setAttribute("data-is-brushable",true);a.classList.add("is-brushable");canvas.addEventListener("mousedown",startBrush);canvas.addEventListener("mouseup",stopBrush);canvas.addEventListener("mousemove",doBrush);canvas.addEventListener("click",doBrush);canvas.addEventListener("mouseleave",brushLeaves);toolSettings.setAttribute("data-tool","brush");return a}function setBrushSize(a){brushSize=a;brushOutline_setSize(a)}function offset(a){var b=a.getBoundingClientRect(),d=window.pageXOffset||document.documentElement.scrollLeft,c=window.pageYOffset||document.documentElement.scrollTop;return{top:b.top+c,left:b.left+d}}function distSq(b,a,d,c){return(b-a)*(b-a)+(d-c)*(d-c)}function crystallize(A,t,p){var f=60;var w=t/f;var c=p/f;var h=[];var v=[];for(var k=0;k<f;k++){for(var l=0;l<f;l++){h[k*f+l]=Math.round(l*w+(Math.random()*w));v[k*f+l]=Math.round(k*c+(Math.random()*c))}}for(var C=0;C<p;C++){for(var B=0;B<t;B++){var o=Math.round(Math.min(Math.floor(B/w),f-1));var m=Math.round(Math.min(Math.floor(C/c),f-1));var d=m*f+o;var e=[d-f-1,d-f,d-f+1,d-1,d,d+1,d+f-1,d+f,d+f+1];var r=[];for(var z=0;z<e.length;z++){var g=e[z];if(g>=0&&g<=h.length-1){r.push(g)}}var s=0;for(var u=0;u<r.length;u++){var q=r[u];if(distSq(h[q],B,v[q],C)<distSq(h[s],B,v[s],C)){s=q}}A[C*t+B]=A[v[s]*t+h[s]]}}}function drawBuffer(a){imageData.data.set(a);ctx.putImageData(imageData,0,0)};